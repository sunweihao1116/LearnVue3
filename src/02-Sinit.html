<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <div id="app"></div>
  <!-- <script src="../dist//vue.global.js"></script> -->
  <script src="./04-reactive.js"></script>
  <script>
  
  // 4. 创建createAppAPI
  const createAppAPI = (render) => {
    return function createApp(rootComponent) {
      let isMounted = false;
      const app = {
        mount(rootContainer) {
          if (!isMounted) {
            // 数据响应式
            // 添加副作用函数
            app._container = rootContainer;
            isMounted = true;
            app.$data = reactive(rootComponent.data());
            rootContainer = {
              rootContainer,
              _vnode: null,
            };
            effect(() => {
              // 1. 获取vnode
              const vnode = rootComponent.render.call(app.$data);
              // 2. 执行render
              render(vnode, rootContainer);
            });
          } else {
            console.error('warn');
          }
        },
      };
      return app;
    };
  };

  const mountComponent = (
    n2,
    container,
    renderFunction,
  ) => {
    // 1. instance 创建组件实例
    // 2. setupComponent  安装组件： 组件初始化
    // 3. setupRenderEffect 安装渲染函数 
    // 4. 副作用effect —组件更新函数添加为副作用函数，如果将来数据发生变化，重新执行组件更新函数
    // 5. patch
    // --------------------
    // init
    // 1. 获取宿主元素
    const parent = renderFunction.querySelector(container);
    // 2. 创建节点
    const child = renderFunction.createElement(n2.tag);
    if (typeof n2.children === 'string') {
      child.innerText = n2.children;
    }
    // 3. 插入
    renderFunction.insert(child, parent);
  };

  // 超简易版 虚拟dom挂载+更新；
  const processComponent = (
    n1 = null,
    n2,
    container,
    renderFunction
  ) => {
    if (n1 !== null) { // 更新
      const parent = renderFunction.querySelector(container);
      const child = renderFunction.querySelector(n2.tag);
      if (typeof n2.children === 'string') {
        child.innerText = n2.children;
      }
      // 3. 插入
      renderFunction.insert(child, parent);
    } else {
      // init
      mountComponent(
        n2,
        container,
        renderFunction,
      );
    }
  };

  const patch = (
    n1 = null,
    n2,
    container,
    renderFunction,
  ) => {
    const { type } = n2;
    switch(type) {
      // case 
      default:
        // processElement, processFragment, processText ...
        processComponent(
          n1,
          n2,
          container,
          renderFunction,
        );
    };
  };

  // processComponent -> mountComponent

  // 3. 创建createRenderer
  const createRenderer = (renderFunction) => {
    // 定义render
    const render = (vnode, container) => {
      console.log('container, render---->', container);
      if (container._vnode) { // 判断是否已挂载
        // update
        // patch
        // unmount(container._vnode, null, null, true);
        patch(container._vnode || null, vnode, container.rootContainer, renderFunction);
      } else {
        // init
        // vnode.initFlag = true;
        patch(null, vnode, container.rootContainer, renderFunction);
      }
      container._vnode = vnode;
      // console.log('--------------------', container.rootContainer);
    };
    return {
      render,
      createApp: createAppAPI(render),
    };
  };

  // 2. 创建renderer
  const renderer = createRenderer({
    querySelector(sel) {
      return document.querySelector(sel);
    },
    createElement(tag) {
      return document.createElement(tag);
    },
    insert(child, parent) {
      parent.appendChild(child);
    },
  });

  // 1 声明Vue
  const Vue = {
    createApp(options) {
      return renderer.createApp(options);
    }
  };

  const h = (tag, props, children) => {
    return { tag, props, children };
  };

  const app = Vue.createApp({
    data() {
      return {
        foo:  'Fooo',
      };
    },
    render() {
      // h独立函数 模拟生成vnode
      // shapeFlag;
      return h('h2', null, this.foo);
    },
  });
  // .use(router)
  // .use(store)
  app.mount('#app');
  
  // 模拟修改数据（结合数据响应式）
  setTimeout(() => {
    app.$data.foo = 'swh';
  }, 1500);

  </script>
</body>
</html>